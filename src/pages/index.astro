---
export const prerender = true;
const clientScript = import.meta.env.DEV
  ? "/src/scripts/index-client.ts"
  : "/scripts/index-client.js";
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/StreamlinePlumpColorWebFlat.svg"
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>å‹é“¾å›¾è°±</title>
    <link rel="stylesheet" href="/src/css/base.css" />
    <link rel="stylesheet" href="/src/css/topbar.css" />
    <link rel="stylesheet" href="/src/css/buttons.css" />
    <link rel="stylesheet" href="/src/css/modal.css" />
  </head>
  <body>
    <div class="topbar">
      <div class="title" style="font-weight:600; padding-left:6px;">
        <span>å‹é“¾å›¾è°±</span>
        <a
          class="github-link"
          href="https://github.com/xingwangzhe/FriendLinks"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Open GitHub repository"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 16 16"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"
            ></path>
          </svg>
        </a>
      </div>
      <div class="search">
        <input
          id="graph-search"
          type="text"
          placeholder="æœç´¢ï¼šç«™ç‚¹åæˆ–åŸŸåï¼ˆç¤ºä¾‹: example.comï¼‰"
          autocomplete="off"
        />
        <div id="graph-search-results" class="results" role="listbox"></div>
      </div>
    </div>
    <div id="main"></div>
    <div class="top-buttons">
      <button id="theme-toggle" class="top-button" aria-label="åˆ‡æ¢ä¸»é¢˜">åˆ‡æ¢ä¸»é¢˜</button>
      <button id="stats-toggle" class="top-button" aria-label="æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯">ğŸ“Šå‹é“¾ç»Ÿè®¡</button>
    </div>

    <!-- ç»Ÿè®¡å¼¹çª— -->
    <div id="stats-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“Š å‹é“¾ç»Ÿè®¡</h2>
          <button class="close-btn" aria-label="å…³é—­">&times;</button>
        </div>
        <div id="stats-content">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
    <style>
      /* é¡¶éƒ¨æŒ‰é’®é€šç”¨æ ·å¼ */
      .top-button {
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--card-bg);
        color: var(--text-color);
        cursor: pointer;
        pointer-events: auto;
        font-size: 14px;
        white-space: nowrap;
      }
      .top-button:focus {
        outline: 2px solid color-mix(in srgb, var(--text-color) 20%, transparent);
      }

      /* æŒ‰é’®å®¹å™¨ */
      .top-buttons {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 60; /* é«˜äº .topbar (20) å’Œç§»åŠ¨ç«¯çš„ #theme-toggle (40) */
        display: flex;
        gap: 8px;
        pointer-events: auto;
      }

      /* è¦†ç›–å¯èƒ½å­˜åœ¨çš„ id é€‰æ‹©å™¨å®šä½ï¼ˆæ¥è‡ª topbar.cssï¼‰ï¼Œç¡®ä¿æŒ‰é’®åœ¨å®¹å™¨å†…æ­£å¸¸å¸ƒå±€ */
      #theme-toggle,
      #stats-toggle {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        z-index: 61 !important;
      }

      /* ç§»åŠ¨ç«¯è°ƒæ•´ */
      @media (max-width: 640px) {
        .top-buttons {
          top: 8px;
          right: 8px;
          gap: 6px;
        }
        .top-button {
          font-size: 12px;
          padding: 4px 8px;
        }
      }

      /* ç»Ÿè®¡å¼¹çª—æ ·å¼ */
      #stats-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.3s ease,
          visibility 0.3s ease;
      }
      #stats-modal.show {
        opacity: 1;
        visibility: visible;
      }
      #stats-modal .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
        margin: 20px; /* åœ¨å°å±å¹•ä¸Šæ·»åŠ è¾¹è· */
      }
      #stats-modal.show .modal-content {
        transform: translateY(0);
      }
      #stats-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }
      #stats-modal .modal-header h2 {
        margin: 0;
        color: var(--text-color);
        font-size: 18px;
      }
      #stats-modal .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #stats-modal .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      #stats-modal .stat-item {
        background: color-mix(in srgb, var(--card-bg) 95%, black 5%);
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 60px;
      }
      #stats-modal .stat-label {
        font-size: 14px;
        color: var(--muted);
        font-weight: 500;
        line-height: 1.2;
      }
      #stats-modal .stat-value {
        font-size: 18px;
        font-weight: bold;
        line-height: 1.2;
        color: #007acc; /* äº®è‰²ä¸»é¢˜ä¸‹çš„é«˜äº®è“è‰² */
      }

      /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ•°å­—é¢œè‰² */
      html[data-theme="dark"] #stats-modal .stat-value {
        color: #4da6ff; /* æš—è‰²ä¸»é¢˜ä¸‹çš„æµ…è“è‰² */
      }
      #stats-modal .loading {
        text-align: center;
        color: var(--muted);
        padding: 40px;
      }
      #stats-modal .error {
        text-align: center;
        color: #e74c3c;
        padding: 40px;
      }
      #stats-modal .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      #stats-modal .stat-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
      }
      #stats-modal .stat-section h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }

      /* ç§»åŠ¨ç«¯å“åº”å¼ */
      @media (max-width: 640px) {
        #stats-modal .modal-content {
          width: calc(100% - 40px);
          margin: 20px;
          padding: 15px;
          max-height: 90vh;
        }
        #stats-modal .stats-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        #stats-modal .stat-section {
          padding: 12px;
        }
        #stats-modal .stat-section h3 {
          font-size: 13px;
          margin-bottom: 10px;
        }
        #stats-modal .stat-item {
          padding: 12px;
          min-height: 50px;
        }
        #stats-modal .stat-label {
          font-size: 13px;
        }
        #stats-modal .stat-value {
          font-size: 16px;
        }
        #stats-modal .modal-header h2 {
          font-size: 16px;
        }
      }
    </style>
    <script type="module" src={clientScript}></script>
    <script lang="js">
      (function () {
        const btn = document.getElementById("theme-toggle");
        const titleText = document.querySelector(".topbar .title span");
        const ghLink = document.querySelector(".topbar a.github-link");

        // åˆå§‹åŒ–å¹¶ç»´æŠ¤ document.dataset.themeï¼Œè®© CSS ä½¿ç”¨å˜é‡åˆ‡æ¢é¢œè‰²
        const mq =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)");
        let isDark = mq
          ? mq.matches
          : document.documentElement.dataset.theme === "dark";
        // åˆå§‹åŒ– datasetï¼Œä»¥ä¾¿ CSS å˜é‡ï¼ˆhtml[data-theme]) ç”Ÿæ•ˆ
        document.documentElement.dataset.theme = isDark ? "dark" : "light";

        // ç‚¹å‡»åˆ‡æ¢æŒ‰é’®æ—¶åŒæ—¶æ›´æ–° document.dataset.theme
        if (btn) {
          btn.addEventListener("click", () => {
            isDark = !isDark;
            document.documentElement.dataset.theme = isDark ? "dark" : "light";
          });
        }

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜æ”¹å˜å¹¶åŒæ­¥
        if (mq && mq.addEventListener) {
          mq.addEventListener("change", (e) => {
            isDark = e.matches;
            document.documentElement.dataset.theme = isDark ? "dark" : "light";
          });
        }

        // ç»Ÿè®¡å¼¹çª—åŠŸèƒ½
        const statsBtn = document.getElementById("stats-toggle");
        const statsModal = document.getElementById("stats-modal");
        const statsContent = document.getElementById("stats-content");
        const closeBtn = statsModal?.querySelector(".close-btn");

        function showStatsModal() {
          if (!statsModal) return;
          statsModal.classList.add("show");
          loadStatsData();
        }

        function hideStatsModal() {
          if (!statsModal) return;
          statsModal.classList.remove("show");
        }

        function loadStatsData() {
          if (!statsContent) return;

          statsContent.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

          fetch("/stats.json")
            .then((response) => {
              if (!response.ok) {
                throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
              }
              return response.json();
            })
            .then((data) => {
              renderStats(data);
            })
            .catch((error) => {
              console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
              statsContent.innerHTML =
                '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }

        function renderStats(data) {
          if (!statsContent) return;

          const statsHtml = `
            <div class="stats-grid">
              <div class="stat-section">
                <h3>æ ¸å¿ƒèŠ‚ç‚¹</h3>
                <div class="stat-item">
                  <span class="stat-label">æ ¸å¿ƒèŠ‚ç‚¹æ•°</span>
                  <span class="stat-value">${data.coreNodes.count}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">å”¯ä¸€åŸŸå</span>
                  <span class="stat-value">${data.coreNodes.uniqueHosts}</span>
                </div>
              </div>

              <div class="stat-section">
                <h3>å‹é“¾èŠ‚ç‚¹</h3>
                <div class="stat-item">
                  <span class="stat-label">å‹é“¾èŠ‚ç‚¹æ€»æ•°</span>
                  <span class="stat-value">${data.friendNodes.total}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">å¤–éƒ¨å‹é“¾</span>
                  <span class="stat-value">${data.friendNodes.externalFriends}</span>
                </div>
              </div>

              <div class="stat-section">
                <h3>æ ¸å¿ƒèŠ‚ç‚¹é—´è¿æ¥</h3>
                <div class="stat-item">
                  <span class="stat-label">è¿æ¥æ€»æ•°</span>
                  <span class="stat-value">${data.connections.coreToCore.total}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">åŒå‘è¿æ¥</span>
                  <span class="stat-value">${data.connections.coreToCore.bidirectional}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">å•å‘è¿æ¥</span>
                  <span class="stat-value">${data.connections.coreToCore.unidirectional}</span>
                </div>
              </div>

              <div class="stat-section">
                <h3>æ ¸å¿ƒèŠ‚ç‚¹åˆ°å‹é“¾</h3>
                <div class="stat-item">
                  <span class="stat-label">è¿æ¥æ•°é‡</span>
                  <span class="stat-value">${data.connections.coreToFriend}</span>
                </div>
              </div>

              <div class="stat-section">
                <h3>æ€»è§ˆ</h3>
                <div class="stat-item">
                  <span class="stat-label">æ‰€æœ‰èŠ‚ç‚¹æ•°</span>
                  <span class="stat-value">${data.overview.totalNodes}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">æ€»è¿æ¥æ•°</span>
                  <span class="stat-value">${data.overview.totalConnections}</span>
                </div>
              </div>
            </div>
          `;

          statsContent.innerHTML = statsHtml;
        }

        if (statsBtn) {
          statsBtn.addEventListener("click", showStatsModal);
        }

        if (closeBtn) {
          closeBtn.addEventListener("click", hideStatsModal);
        }

        if (statsModal) {
          statsModal.addEventListener("click", (e) => {
            if (e.target === statsModal) {
              hideStatsModal();
            }
          });
        }

        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && statsModal?.classList.contains("show")) {
            hideStatsModal();
          }
        });
      })();
    </script>
  </body>
</html>
